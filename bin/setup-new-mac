#!/usr/bin/env bash
#
# setup-new-mac
# Set up a new Mac with dotfiles and essential packages
#

set -e

DOTFILES_DIR="$HOME/Library/Mobile Documents/com~apple~CloudDocs/dotfiles"

echo "=== Setting up new Mac ==="
echo ""

# Create iCloud symlink
cd "$HOME"
if [ -L .icloud-drive ]; then
	echo "✓ .icloud-drive symlink exists"
else
	ln -s "$HOME/Library/Mobile Documents/com~apple~CloudDocs" .icloud-drive
	echo "✓ Created .icloud-drive symlink"
fi

# Create basic dotfile symlinks
echo ""
echo "=== Creating dotfile symlinks ==="

basic_links="
.emacs
.gemrc
.gitconfig
.gitignore_global
.profile
.aliases.sh
.aliases.fish
.aliases.nu
.zshrc
.zshenv
.zprofile
.shell-common.sh
.lldbinit
.lldb-gdb
.hammer
"

for link in $basic_links; do
	if [ -L "$HOME/$link" ]; then
		echo "✓ $link"
	elif [ -f "$DOTFILES_DIR/$link" ]; then
		ln -s ".icloud-drive/dotfiles/$link" "$HOME/$link"
		echo "✓ $link (created)"
	fi
done

# Create .bin symlink
if [ -L "$HOME/.bin" ]; then
	echo "✓ .bin"
else
	ln -s ".icloud-drive/dotfiles/bin" "$HOME/.bin"
	echo "✓ .bin (created)"
fi

# Create .ssh config symlink
echo ""
echo "=== Setting up SSH config ==="
mkdir -p "$HOME/.ssh"
if [ -L "$HOME/.ssh/config" ]; then
	echo "✓ .ssh/config"
else
	ln -s "$HOME/.icloud-drive/dotfiles/.ssh/config" "$HOME/.ssh/config"
	echo "✓ .ssh/config (created)"
fi

# Run shell symlinks setup (for config directories)
echo ""
echo "=== Setting up shell configs ==="
if [ -x "$DOTFILES_DIR/bin/setup-shell-symlinks" ]; then
	"$DOTFILES_DIR/bin/setup-shell-symlinks"
fi

# Set macOS defaults
echo ""
echo "=== Setting macOS defaults ==="

# Disable shadows on window screenshots
defaults write com.apple.screencapture disable-shadow -bool true
echo "✓ Disabled screenshot shadows"

# Install Homebrew if needed
echo ""
echo "=== Homebrew ==="
if command -v brew &>/dev/null; then
	echo "✓ Homebrew installed"
	brew update
else
	echo "Installing Homebrew..."
	/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
	eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Install packages from Brewfile.basics
echo ""
echo "=== Installing essential packages ==="
if [ -f "$DOTFILES_DIR/Brewfile.basics" ]; then
	brew bundle install --file="$DOTFILES_DIR/Brewfile.basics"
else
	echo "⚠ Brewfile.basics not found."
	exit 1
fi

# Add shells to /etc/shells if needed
echo ""
echo "=== Registering shells ==="
for shell in /opt/homebrew/bin/fish /opt/homebrew/bin/nu; do
	if [ -x "$shell" ]; then
		if grep -q "^$shell$" /etc/shells; then
			echo "✓ $shell already in /etc/shells"
		else
			echo "$shell" | sudo tee -a /etc/shells
			echo "✓ Added $shell to /etc/shells"
		fi
	fi
done

# Mount secure dotfiles
echo ""
echo "=== Secure dotfiles ==="
if [ -d /Volumes/secure-dotfiles ]; then
	echo "✓ Secure dotfiles already mounted"
elif [ -f "$DOTFILES_DIR/secure.dmg" ]; then
	echo "Opening secure dotfiles..."
	open "$DOTFILES_DIR/secure.dmg"
else
	echo "⚠ secure.dmg not found"
fi

echo ""
echo "=== Setup complete ==="
echo ""
echo "Next steps:"
echo "  1. Run 'chsh -s /bin/zsh' to set zsh as login shell"
echo "  2. Configure Ghostty to launch fish: command = /opt/homebrew/bin/fish"
echo "  3. Open a new terminal to test"
